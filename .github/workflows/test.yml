name: test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Resolve Latest Docker Digests Action
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test resolving multiple images
        id: test-multi
        uses: ./
        with:
          image-urls: |
            nginx:latest
            hello-world:latest
        continue-on-error: true
      
      - name: Show results
        run: |
          echo "Test completed"
          if [[ "${{ steps.test-multi.outcome }}" == "success" ]]; then
            echo "✅ Action succeeded"
            echo "JSON Output: ${{ steps.test-multi.outputs.image-digest-urls }}"
            
            # Extract digest URLs using jq
            RESULTS='${{ steps.test-multi.outputs.image-digest-urls }}'
            NGINX_DIGEST_URL=$(echo "$RESULTS" | jq -r '."nginx:latest" // "not-found"')
            HELLO_DIGEST_URL=$(echo "$RESULTS" | jq -r '."hello-world:latest" // "not-found"')
            echo "Nginx Digest URL: $NGINX_DIGEST_URL"
            echo "Hello World Digest URL: $HELLO_DIGEST_URL"
          else
            echo "❌ Action failed"
            echo "This might indicate an issue with the action"
          fi
      
      - name: Validate PowerShell syntax
        run: |
          pwsh -Command "
          try {
            \$null = [System.Management.Automation.PSParser]::Tokenize((Get-Content './action.ps1' -Raw), [ref]\$null)
            Write-Output '✅ PowerShell syntax is valid'
          } catch {
            Write-Error 'PowerShell syntax error in action.ps1'
            Write-Error \$_.Exception.Message
            exit 1
          }"
      
      - name: Test action.yml validity
        run: |
          if [[ ! -f "action.yml" ]]; then
            echo "❌ action.yml not found"
            exit 1
          fi
          
          # Basic YAML syntax check
          python -c "import yaml; yaml.safe_load(open('action.yml'))" || exit 1
          echo "✅ action.yml is valid YAML"
