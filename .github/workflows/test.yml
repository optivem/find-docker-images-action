name: Test Action

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Inspect Docker Images Action
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test with multiple images
        id: test-multi
        uses: ./
        with:
          images: |
            [
              {
                "repo-owner": "library",
                "repo-name": "hello-world",
                "image-name": "hello-world",
                "version": "latest"
              }
            ]
        continue-on-error: true
      
      - name: Show results
        run: |
          echo "Test completed"
          if [[ "${{ steps.test-multi.outcome }}" == "success" ]]; then
            echo "✅ Action succeeded"
            echo "JSON Output: ${{ steps.test-multi.outputs.digests-json }}"
            
            # Extract digest using jq
            RESULTS='${{ steps.test-multi.outputs.digests-json }}'
            HELLO_DIGEST=$(echo "$RESULTS" | jq -r '."hello-world".digest // "not-found"')
            echo "Hello World Digest: $HELLO_DIGEST"
          else
            echo "❌ Action failed (this might be expected for public test images)"
          fi
      
      - name: Validate PowerShell syntax
        run: |
          pwsh -Command "Get-Content './action.ps1' | ForEach-Object { if ($_ -match '^\s*#.*$|^\s*$') { return } ; try { [System.Management.Automation.PSParser]::Tokenize($_, [ref]$null) | Out-Null } catch { Write-Error 'PowerShell syntax error'; exit 1 } }"
      
      - name: Test action.yml validity
        run: |
          if [[ ! -f "action.yml" ]]; then
            echo "❌ action.yml not found"
            exit 1
          fi
          
          # Basic YAML syntax check
          python -c "import yaml; yaml.safe_load(open('action.yml'))" || exit 1
          echo "✅ action.yml is valid YAML"